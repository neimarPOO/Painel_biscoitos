<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle: Startup de Natal</title>
    
    <!-- Material Design 3 -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined" rel="stylesheet">
    <script type="importmap">
        { "imports": { "@material/web/": "https://esm.run/@material/web/" } }
    </script>
    <script type="module">
        import '@material/web/all.js';
        import { styles as typescaleStyles } from '@material/web/typography/md-typescale-styles.js';
        document.adoptedStyleSheets.push(typescaleStyles.styleSheet);
    </script>

    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--md-sys-color-surface-container-low);
        }
        .main-content {
            max-width: 1000px;
            margin: 0 auto;
            padding: 16px;
        }
        md-top-app-bar {
            --md-sys-color-primary: var(--md-sys-color-surface);
            --md-sys-color-on-primary: var(--md-sys-color-on-surface);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        md-tabs {
            background-color: var(--md-sys-color-surface);
        }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        .card {
            background-color: var(--md-sys-color-surface);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            border: 1px solid var(--md-sys-color-outline-variant);
        }
        .card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }
        .card-header h3 {
            margin: 0;
            font-size: 1.25rem;
            color: var(--md-sys-color-on-surface);
        }
        .grid { display: grid; gap: 16px; }
        .flex { display: flex; }
        .gap-2 { gap: 8px; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        
        /* Timeline */
        .timeline-item {
            position: relative;
            padding-left: 40px;
            padding-bottom: 24px;
        }
        .timeline-item:last-child { padding-bottom: 0; }
        .timeline-connector {
            position: absolute;
            left: 15px;
            top: 20px;
            bottom: -20px;
            width: 2px;
            background-color: var(--md-sys-color-outline-variant);
        }
        .timeline-icon {
            position: absolute;
            left: 0;
            top: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }
        .task-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-radius: 8px;
            background-color: var(--md-sys-color-surface-container-highest);
            margin-bottom: 8px;
        }
        .task-item.done { opacity: 0.7; }
        .task-item.done .task-title { text-decoration: line-through; }
        .task-title { flex-grow: 1; cursor: pointer; }
        .assignee-chip { font-size: 0.75rem; --md-input-chip-label-color: var(--md-sys-color-on-surface-variant); }
    </style>
</head>
<body>

    <md-top-app-bar>
        <div slot="headline">Gest√£o da Startup</div>
        <md-icon-button slot="action" onclick="resetData()">
            <md-icon>restart_alt</md-icon>
        </md-icon-button>
    </md-top-app-bar>

    <md-tabs aria-label="Abas de conte√∫do" @change="switchTab(event)">
        <md-primary-tab id="tab-btn-cronograma" aria-controls="tab-cronograma">
            <md-icon slot="icon">task_alt</md-icon>
            Cronograma
        </md-primary-tab>
        <md-primary-tab id="tab-btn-custos" aria-controls="tab-custos">
            <md-icon slot="icon">calculate</md-icon>
            Calculadora
        </md-primary-tab>
    </md-tabs>

    <main class="main-content">
        <!-- TAB: CRONOGRAMA / TAREFAS -->
        <div id="tab-cronograma" class="tab-panel active">
            <div class="card">
                <div class="card-header">
                    <md-icon>groups</md-icon>
                    <h3>Equipe da Startup</h3>
                </div>
                <div class="flex gap-2 items-center">
                    <md-outlined-text-field label="Nome do integrante" id="new-member-name" style="flex-grow: 1;"></md-outlined-text-field>
                    <md-filled-button onclick="addMember()">
                        <md-icon slot="icon">add</md-icon>
                        Adicionar
                    </md-filled-button>
                </div>
                <md-chip-set id="team-list" class="mt-4"></md-chip-set>
                <p id="no-members-msg" class="md-typescale-body-medium" style="color: var(--md-sys-color-outline);">Adicione os integrantes para delegar tarefas.</p>
            </div>

            <div id="timeline-container"></div>
        </div>

        <!-- TAB: CUSTOS (CALCULATOR) -->
        <div id="tab-custos" class="tab-panel">
            <div class="grid" style="grid-template-columns: 2fr 1fr; align-items: start;">
                <div class="flex" style="flex-direction: column; gap: 16px;">
                    <div class="card">
                        <div class="card-header"><h3>Meta de Produ√ß√£o</h3></div>
                        <md-outlined-text-field id="meta-qtd" label="Meta de Quantidade" type="number" value="50" suffix-text="unidades"></md-outlined-text-field>
                    </div>

                    <div class="card">
                        <div class="card-header"><h3>Ingredientes da Receita Base</h3></div>
                        <div id="ingredient-inputs"></div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header"><h3>Custos Extras & Fixos</h3></div>
                        <div id="extra-costs-inputs"></div>
                    </div>
                </div>

                <div class="card" style="position: sticky; top: 80px;">
                    <h3 class="md-typescale-title-large" style="text-align: center; margin-bottom: 16px;">Resultado</h3>
                    
                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 8px;">
                        <div style="background: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container); padding: 8px; border-radius: 8px;">
                            <p class="md-typescale-label-medium">Custo Startup</p>
                            <p class="md-typescale-headline-small">R$ <span id="cost-startup">0.00</span></p>
                        </div>
                        <div style="background: var(--md-sys-color-tertiary-container); color: var(--md-sys-color-on-tertiary-container); padding: 8px; border-radius: 8px;">
                            <p class="md-typescale-label-medium">Custo "De Casa"</p>
                            <p class="md-typescale-headline-small">R$ <span id="cost-own">0.00</span></p>
                        </div>
                    </div>
                    <hr style="margin: 16px 0; border-color: var(--md-sys-color-outline-variant);">
                    <div class="flex justify-between items-center">
                        <p class="md-typescale-body-large">Custo Unit√°rio</p>
                        <p class="md-typescale-headline-medium">R$ <span id="unit-cost">0.00</span></p>
                    </div>
                    <hr style="margin: 16px 0; border-color: var(--md-sys-color-outline-variant);">
                    
                    <label class="md-typescale-body-medium">Margem de Lucro: <span id="margin-display" style="font-weight: bold;">50%</span></label>
                    <md-slider id="margin-slider" min="0" max="300" value="50" labeled ticks></md-slider>

                    <div style="background-color: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); padding: 16px; border-radius: 12px; text-align: center; margin-top: 16px;">
                        <p class="md-typescale-label-large">PRE√áO DE VENDA</p>
                        <p class="md-typescale-display-small">R$ <span id="final-price">0.00</span></p>
                        <p class="md-typescale-body-medium">Lucro por unidade: R$ <span id="profit-unit">0.00</span></p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Task Dialog -->
    <md-dialog id="task-dialog">
        <div slot="headline" id="dialog-title">Nova Tarefa</div>
        <form slot="content" id="task-form" method="dialog">
            <md-outlined-text-field label="O que precisa ser feito?" id="modal-task-name" required style="width: 100%; margin-bottom: 16px;"></md-outlined-text-field>
            <md-outlined-select label="Quem √© o respons√°vel?" id="modal-task-assignee" style="width: 100%; margin-bottom: 16px;">
            </md-outlined-select>
            <div id="modal-status-wrapper" style="display: none;">
                <md-outlined-select label="Status" id="modal-task-status" style="width: 100%;">
                    <md-select-option value="todo"><div slot="headline">A Fazer</div></md-select-option>
                    <md-select-option value="done"><div slot="headline">Conclu√≠do</div></md-select-option>
                </md-outlined-select>
            </div>
        </form>
        <div slot="actions">
            <md-text-button form="task-form" value="cancel">Cancelar</md-text-button>
            <md-text-button form="task-form" value="save" onclick="saveTask()">Salvar</md-text-button>
        </div>
    </md-dialog>

    <script type="module">
        // ==========================
        // 1. SETUP & STATE
        // ==========================
        const STORAGE_KEY_V3 = 'startup_natal_v3_data';

        const phasesConfig = [
            { id: 'p1', title: 'Semana 1: Idea√ß√£o & Marca', dates: '18-24 Nov', icon: 'looks_one' },
            { id: 'p2', title: 'Semana 2: Finan√ßas & Web', dates: '25-30 Nov', icon: 'looks_two' },
            { id: 'p3', title: 'Produ√ß√£o', dates: '01-10 Dez', icon: 'local_fire_department' },
            { id: 'p4', title: 'A Grande Feira', dates: '13 Dez', icon: 'star' }
        ];
        
        const defaultData = {
            members: [],
            tasks: [
                { id: 1, phaseId: 'p1', title: "Definir a Dupla & Persona", assignee: "Todos", status: "done" },
                { id: 2, phaseId: 'p1', title: "Criar Nome e Logo no Canva", assignee: "", status: "todo" },
                { id: 3, phaseId: 'p2', title: "Comprar Ingredientes", assignee: "", status: "todo" },
                { id: 4, phaseId: 'p2', title: "Criar p√°gina no Site", assignee: "", status: "todo" },
                { id: 5, phaseId: 'p3', title: "Assar primeira leva", assignee: "", status: "todo" },
                { id: 6, phaseId: 'p3', title: "Embalar produtos", assignee: "", status: "todo" }
            ]
        };

        let appData = JSON.parse(localStorage.getItem(STORAGE_KEY_V3)) || JSON.parse(JSON.stringify(defaultData));

        function saveData() {
            localStorage.setItem(STORAGE_KEY_V3, JSON.stringify(appData));
            renderApp();
        }

        window.resetData = () => {
            if(confirm("Isso apagar√° todas as tarefas e membros criados. Tem certeza?")) {
                appData = JSON.parse(JSON.stringify(defaultData));
                saveData();
                renderCalculator(); // Also re-render calculator to default values
                calculate();
            }
        }

        // ==========================
        // 2. TAB LOGIC
        // ==========================
        window.switchTab = (event) => {
            const activeTab = event.target.activeTab;
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            const panelId = activeTab.getAttribute('aria-controls');
            document.getElementById(panelId).classList.add('active');
        }

        // ==========================
        // 3. TEAM LOGIC
        // ==========================
        const memberNameInput = document.getElementById('new-member-name');
        const teamList = document.getElementById('team-list');
        const noMembersMsg = document.getElementById('no-members-msg');

        window.addMember = () => {
            const name = memberNameInput.value.trim();
            if(!name) return;
            
            if(!appData.members) appData.members = [];
            appData.members.push(name);
            memberNameInput.value = '';
            saveData();
        }

        function removeMember(index) {
            appData.members.splice(index, 1);
            saveData();
        }

        function renderTeam() {
            teamList.innerHTML = '';
            noMembersMsg.style.display = (!appData.members || appData.members.length === 0) ? 'block' : 'none';

            appData.members?.forEach((member, index) => {
                const chip = document.createElement('md-input-chip');
                chip.label = member;
                chip.selected = true;
                chip.addEventListener('remove', () => removeMember(index));
                teamList.appendChild(chip);
            });
        }

        // ==========================
        // 4. TIMELINE & TASK LOGIC
        // ==========================
        const taskDialog = document.getElementById('task-dialog');
        const dialogTitle = document.getElementById('dialog-title');
        const taskNameInput = document.getElementById('modal-task-name');
        const taskAssigneeSelect = document.getElementById('modal-task-assignee');
        const statusWrapper = document.getElementById('modal-status-wrapper');
        const taskStatusSelect = document.getElementById('modal-task-status');
        const timelineContainer = document.getElementById('timeline-container');

        let currentEditingTaskId = null;
        let currentAddingPhaseId = null;

        window.openTaskModal = (phaseId = null, taskId = null) => {
            taskAssigneeSelect.innerHTML = '<md-select-option value=""><div slot="headline">Ningu√©m</div></md-select-option>';
            appData.members?.forEach(m => {
                const opt = document.createElement('md-select-option');
                opt.value = m;
                opt.innerHTML = `<div slot="headline">${m}</div>`;
                taskAssigneeSelect.appendChild(opt);
            });

            if (taskId) { // Edit mode
                const task = appData.tasks.find(t => t.id === taskId);
                currentEditingTaskId = taskId;
                currentAddingPhaseId = null;
                
                dialogTitle.innerText = "Editar Tarefa";
                taskNameInput.value = task.title;
                taskAssigneeSelect.value = task.assignee || "";
                statusWrapper.style.display = 'block';
                taskStatusSelect.value = task.status;
            } else { // Create mode
                currentEditingTaskId = null;
                currentAddingPhaseId = phaseId;
                
                dialogTitle.innerText = "Nova Tarefa";
                taskNameInput.value = "";
                taskAssigneeSelect.value = "";
                statusWrapper.style.display = 'none';
            }
            taskDialog.show();
        }

        window.saveTask = () => {
            const title = taskNameInput.value.trim();
            if (!title) return;

            if (currentEditingTaskId) {
                const task = appData.tasks.find(t => t.id === currentEditingTaskId);
                task.title = title;
                task.assignee = taskAssigneeSelect.value;
                task.status = taskStatusSelect.value;
            } else {
                appData.tasks.push({
                    id: Date.now(),
                    phaseId: currentAddingPhaseId,
                    title,
                    assignee: taskAssigneeSelect.value,
                    status: 'todo'
                });
            }
            saveData();
            taskDialog.close();
        }

        function toggleTaskStatus(id) {
            const task = appData.tasks.find(t => t.id === id);
            if(task) {
                task.status = (task.status === 'todo') ? 'done' : 'todo';
                saveData();
            }
        }

        function deleteTask(id) {
            if(confirm("Excluir tarefa?")) {
                appData.tasks = appData.tasks.filter(t => t.id !== id);
                saveData();
            }
        }

        function renderTimeline() {
            timelineContainer.innerHTML = '';
            phasesConfig.forEach(phase => {
                const phaseTasks = appData.tasks.filter(t => t.phaseId === phase.id);
                const phaseEl = document.createElement('div');
                phaseEl.className = 'timeline-item';
                
                const tasksContainer = document.createElement('div');
                tasksContainer.style.marginTop = '16px';

                phaseTasks.forEach(task => {
                    const taskEl = document.createElement('div');
                    taskEl.className = `task-item ${task.status}`;
                    const assigneeChip = task.assignee ? `<md-input-chip label="${task.assignee}" class="assignee-chip" disabled selected></md-input-chip>` : '';
                    
                    taskEl.innerHTML = `
                        <md-icon-button class="toggle-status">
                            <md-icon>${task.status === 'done' ? 'check_circle' : 'radio_button_unchecked'}</md-icon>
                        </md-icon-button>
                        <span class="task-title md-typescale-body-large">${task.title}</span>
                        ${assigneeChip}
                        <md-icon-button class="edit-task"><md-icon>edit</md-icon></md-icon-button>
                        <md-icon-button class="delete-task"><md-icon>delete</md-icon></md-icon-button>
                    `;
                    
                    taskEl.querySelector('.toggle-status').addEventListener('click', () => toggleTaskStatus(task.id));
                    taskEl.querySelector('.task-title').addEventListener('click', () => openTaskModal(null, task.id));
                    taskEl.querySelector('.edit-task').addEventListener('click', () => openTaskModal(null, task.id));
                    taskEl.querySelector('.delete-task').addEventListener('click', () => deleteTask(task.id));
                    
                    tasksContainer.appendChild(taskEl);
                });

                const newButton = document.createElement('md-text-button');
                newButton.style.marginTop = '8px';
                newButton.innerHTML = '<md-icon slot="icon">add_circle_outline</md-icon> Nova Tarefa';
                newButton.addEventListener('click', () => openTaskModal(phase.id));

                phaseEl.innerHTML = `
                    <div class="timeline-connector"></div>
                    <div class="timeline-icon"><md-icon>${phase.icon}</md-icon></div>
                    <h3 class="md-typescale-title-large" style="margin-left: 40px;">${phase.title}</h3>
                    <p class="md-typescale-label-medium" style="margin-left: 40px; color: var(--md-sys-color-outline);">${phase.dates}</p>
                `;
                phaseEl.appendChild(tasksContainer);
                phaseEl.appendChild(newButton);
                timelineContainer.appendChild(phaseEl);
            });
        }

        // ==========================
        // 5. CALCULATOR LOGIC
        // ==========================
        const ingredientData = [
            { name: 'Farinha de Trigo', price: 5.00, grams: 300, source: 'startup' },
            { name: 'A√ß√∫car', price: 4.50, grams: 100, source: 'startup' },
            { name: 'Manteiga/Marg.', price: 60.00, grams: 200, source: 'startup' }
        ];
        const extraCostData = [
            { name: 'Ingredientes Extras', placeholder: 'Chocolate, Confeitos...', source: 'startup' },
            { name: 'Embalagens', placeholder: 'Sacos, Fitas, Caixas', source: 'startup' },
            { name: 'G√°s / Energia', placeholder: 'Ex: 5.00', source: 'proprio' }
        ];

        const ingredientInputsEl = document.getElementById('ingredient-inputs');
        const extraCostsInputsEl = document.getElementById('extra-costs-inputs');
        
        let calcElements = [];

        function renderCalculator() {
            ingredientInputsEl.innerHTML = '';
            extraCostsInputsEl.innerHTML = '';
            calcElements = [];

            ingredientData.forEach((item, index) => {
                const el = document.createElement('div');
                el.className = 'grid items-center';
                el.style.gridTemplateColumns = '1fr 1fr 1fr 1fr';
                const priceId = `ing-price-${index}`;
                const gramsId = `ing-grams-${index}`;
                const sourceId = `ing-source-${index}`;
                
                el.innerHTML = `
                    <label class="md-typescale-body-large">${item.name}</label>
                    <md-outlined-text-field id="${priceId}" label="Pre√ßo/Kg" type="number" value="${item.price}" prefix-text="R$"></md-outlined-text-field>
                    <md-outlined-text-field id="${gramsId}" label="Gramas" type="number" value="${item.grams}" suffix-text="g"></md-outlined-text-field>
                    <md-outlined-select id="${sourceId}" label="Fonte">
                        <md-select-option value="startup" ${item.source === 'startup' ? 'selected' : ''}><div slot="headline">üí∞ Startup</div></md-select-option>
                        <md-select-option value="proprio" ${item.source === 'proprio' ? 'selected' : ''}><div slot="headline">üè† Casa</div></md-select-option>
                    </md-outlined-select>
                `;
                ingredientInputsEl.appendChild(el);
                calcElements.push({ type: 'ingredient', price: document.getElementById(priceId), grams: document.getElementById(gramsId), source: document.getElementById(sourceId) });
            });
            
            extraCostData.forEach((item, index) => {
                const el = document.createElement('div');
                el.className = 'grid items-center';
                el.style.gridTemplateColumns = '1fr 1fr 1fr';
                const costId = `extra-cost-${index}`;
                const sourceId = `extra-source-${index}`;
                
                el.innerHTML = `
                    <label class="md-typescale-body-large">${item.name}</label>
                    <md-outlined-text-field id="${costId}" label="Custo Total" type="number" placeholder="${item.placeholder}" prefix-text="R$"></md-outlined-text-field>
                    <md-outlined-select id="${sourceId}" label="Fonte">
                        <md-select-option value="startup" ${item.source === 'startup' ? 'selected' : ''}><div slot="headline">üí∞ Startup</div></md-select-option>
                        <md-select-option value="proprio" ${item.source === 'proprio' ? 'selected' : ''}><div slot="headline">üè† Casa</div></md-select-option>
                    </md-outlined-select>
                `;
                extraCostsInputsEl.appendChild(el);
                calcElements.push({ type: 'extra', cost: document.getElementById(costId), source: document.getElementById(sourceId) });
            });

            document.querySelectorAll('md-outlined-text-field, md-slider, md-outlined-select').forEach(el => {
                el.addEventListener('input', calculate);
                el.addEventListener('change', calculate);
            });
        }

        function calculate() {
            let totalStartup = 0;
            let totalOwn = 0;

            calcElements.forEach(el => {
                const source = el.source.value;
                let cost = 0;
                if (el.type === 'ingredient') {
                    const pricePerKg = parseFloat(el.price.value) || 0;
                    const grams = parseFloat(el.grams.value) || 0;
                    cost = (pricePerKg / 1000) * grams;
                } else if (el.type === 'extra') {
                    cost = parseFloat(el.cost.value) || 0;
                }

                if (source === 'startup') {
                    totalStartup += cost;
                } else {
                    totalOwn += cost;
                }
            });

            const totalCost = totalStartup + totalOwn;
            const quantity = parseFloat(document.getElementById('meta-qtd').value) || 1;
            const unitCost = totalCost / quantity;
            const margin = document.getElementById('margin-slider').value;
            const finalPrice = unitCost * (1 + (margin/100));
            const profit = finalPrice - unitCost;

            document.getElementById('cost-startup').innerText = totalStartup.toFixed(2);
            document.getElementById('cost-own').innerText = totalOwn.toFixed(2);
            document.getElementById('total-cost').innerText = totalCost.toFixed(2);
            document.getElementById('unit-cost').innerText = unitCost.toFixed(2);
            document.getElementById('margin-display').innerText = `${margin}%`;
            document.getElementById('final-price').innerText = finalPrice.toFixed(2);
            document.getElementById('profit-unit').innerText = profit.toFixed(2);
        }

        // ==========================
        // INITIAL RENDER
        // ==========================
        function renderApp() {
            renderTeam();
            renderTimeline();
        }

        renderCalculator();
        renderApp();
        calculate();

    </script>
</body>
</html>